# Архитектура MCP сервера для работы с OData 1C

## Обзор проекта

MCP сервер предоставляет интерфейс для работы с системой 1С через протокол OData. Сервер реализован на Python с использованием фреймворка FastMCP и предоставляет инструменты для:

- Получения метаданных и структуры объектов 1С с сохранением в JSON
- Выполнения запросов к данным с сохранением в JSON файлы  
- Работы с локальными JSON данными без обращения к 1С
- Создания, редактирования и удаления документов
- Создания специализированных документов РТиУ с бизнес-логикой

**Особенность архитектуры**: Все данные сохраняются в JSON файлы, а функции возвращают только статусную информацию. Это предотвращает переполнение контекста LLM большими объемами данных.

## Структура проекта

```
mcp_1c/
├── src/
│   ├── __init__.py
│   └── mcp_1c/
│       ├── __init__.py          # Основной пакет
│       ├── client.py            # OData клиент для подключения к 1С
│       ├── cache.py             # Система кэширования метаданных
│       ├── tools.py             # MCP инструменты
│       └── server.py            # Основной MCP сервер
├── cache/                       # Директория кэша данных (создается автоматически)
│   ├── metadata.json           # Кэш сырых метаданных
│   ├── metadata_info.json      # Кэш обработанных метаданных
│   └── data/                   # Директория с данными запросов
│       ├── Catalog_Products_abc123.json    # Данные каталога товаров
│       ├── Document_SalesOrder_def456.json # Данные заказов покупателей
│       └── ...                 # Другие файлы с данными
├── main.py                      # Точка входа приложения
├── config.example               # Пример конфигурации
├── pyproject.toml              # Зависимости и метаданные проекта
├── uv.lock                     # Файл блокировки зависимостей
├── architecture.md             # Документация архитектуры (этот файл)
└── README.md                   # Описание проекта
```

## Описание модулей

### `src/mcp_1c/cache.py`
**Назначение**: Система кэширования данных и метаданных

**Основные классы**:
- `DataCache` - управление кэшем данных и метаданных

**Функциональность**:
- Кэширование сырых XML метаданных в JSON
- Кэширование обработанных метаданных
- Сохранение данных запросов в отдельные JSON файлы
- Фильтрация, сортировка и подсчет локальных данных без обращения к 1С
- Анализ структуры JSON файлов с определением типов полей
- Проверка актуальности кэша по времени (TTL)
- Автоматическое создание директорий кэша
- Получение информации о состоянии кэша
- Очистка кэша метаданных и данных

### `src/mcp_1c/client.py`
**Назначение**: OData клиент для взаимодействия с 1С

**Основные классы**:
- `ODataConfig` - конфигурация подключения (URL, учетные данные, настройки)
- `ODataClient` - основной клиент для HTTP запросов к OData API

**Функциональность**:
- Аутентификация через Basic Auth
- Получение метаданных с кэшированием ($metadata endpoint)
- CRUD операции с сущностями
- Выполнение OData запросов с фильтрацией, сортировкой, пагинацией
- Интеграция с системой кэширования
- Управление кэшем метаданных
- Обработка ошибок и логирование

### `src/mcp_1c/tools.py`
**Назначение**: MCP инструменты для работы с 1С

**Основные модели данных**:
- `MetadataInfo` - информация о метаданных 1С
- `QueryResult` - результат запроса к данным
- `DocumentCreateRequest` - запрос на создание документа
- `RTUDocumentRequest` - запрос на создание документа РТиУ

**MCP инструменты**:

*Получение данных из 1С:*
- `fetch_1c_metadata()` - получение и сохранение структуры метаобъектов в JSON
- `fetch_1c_data()` - получение данных из 1С и сохранение в JSON файл
- `get_1c_entity()` - получение конкретной сущности по ключу

*CRUD операции:*
- `create_1c_entity()` - создание любых сущностей (справочники, документы и др.)
- `update_1c_entity()` - обновление любых сущностей в 1С
- `delete_1c_document()` - удаление документа
- `create_rtu_document()` - создание документа РТиУ с бизнес-правилами
- `create_1c_document()` - создание документа (устаревшая функция)
- `update_1c_document()` - обновление документа (устаревшая функция)

*Работа с локальными данными:*
- `list_cached_data()` - получение списка всех сохраненных JSON файлов
- `get_file_structure()` - анализ структуры JSON файла (поля, типы, примеры значений)
- `filter_local_data()` - фильтрация и сортировка данных из локального JSON файла
- `count_local_data()` - подсчет записей в локальном JSON файле

*Управление кэшем:*
- `get_cache_info()` - получение информации о состоянии кэша
- `clear_metadata_cache()` - очистка кэша метаданных
- `clear_data_cache()` - очистка всех сохраненных данных

### `src/mcp_1c/server.py`
**Назначение**: Основной MCP сервер и конфигурация

**Функциональность**:
- Настройка логирования через loguru
- Чтение конфигурации из переменных окружения
- Создание и настройка MCP сервера
- Регистрация ресурсов справочной информации
- Точка входа для запуска сервера

**MCP ресурсы**:
- `config://odata` - конфигурация OData подключения
- `help://tools` - справка по инструментам и примеры использования

### `main.py`
**Назначение**: Точка входа приложения

Простой скрипт для запуска MCP сервера из корневой директории проекта.

## Конфигурация

Сервер настраивается через переменные окружения:

- `ODATA_BASE_URL` - URL OData сервиса 1С
- `ODATA_USERNAME` - имя пользователя
- `ODATA_PASSWORD` - пароль
- `ODATA_TIMEOUT` - таймаут запросов (по умолчанию 30 сек)
- `ODATA_VERIFY_SSL` - проверка SSL сертификата (по умолчанию true)
- `METADATA_CACHE_DIR` - директория для кэша метаданных (по умолчанию cache)
- `METADATA_CACHE_TTL_HOURS` - время жизни кэша в часах (по умолчанию 24)
- `MCP_1C_LOG_FILE` - путь к файлу логов (опционально)

## Зависимости

Основные зависимости проекта:

- `fastmcp>=2.12.4` - фреймворк для создания MCP серверов
- `httpx>=0.28.1` - HTTP клиент для асинхронных запросов
- `loguru>=0.7.3` - библиотека для логирования
- `pydantic` - валидация данных и сериализация
- `xmltodict` - парсинг XML метаданных OData
- `python-dateutil` - работа с датами

## Особенности реализации

### OData протокол
Сервер работает с стандартным OData API 1С, поддерживая:
- Получение метаданных через `$metadata`
- Фильтрацию через `$filter`
- Выборку полей через `$select`
- Сортировку через `$orderby`
- Пагинацию через `$top` и `$skip`

### Бизнес-логика РТиУ
Специальный инструмент `create_rtu_document()` реализует создание документов "Реализация товаров и услуг" с учетом бизнес-правил:
- Проверка существования базового документа
- Копирование данных из базового документа
- Автоматическое заполнение системных полей
- Создание табличной части с товарами

### Логирование
Используется библиотека loguru для структурированного логирования:
- Цветной вывод в консоль
- Опциональная запись в файл с ротацией
- Различные уровни логирования для разработки и продакшена

### JSON-ориентированная архитектура
Все данные сохраняются в JSON файлы для предотвращения переполнения контекста LLM:
- Функции возвращают только статусную информацию
- Данные автоматически сохраняются в структурированные JSON файлы
- Локальная фильтрация и подсчет без обращения к 1С
- Каждый запрос создает отдельный JSON файл с хешированным именем

### Кэширование данных  
Система кэширования повышает производительность:
- Двухуровневое кэширование метаданных (сырые XML + обработанные данные)
- Кэширование данных запросов в отдельные JSON файлы
- Автоматическая проверка актуальности по времени (TTL)
- Возможность принудительного обновления кэша
- Управление кэшем через MCP инструменты
- Настраиваемое время жизни кэша

### Обработка ошибок
Все операции с 1С обрабатывают ошибки:
- HTTP ошибки с детальным логированием
- Ошибки парсинга данных
- Ошибки валидации входных параметров
- Ошибки работы с кэшем
- Graceful shutdown при остановке сервера

## Использование

### Рекомендуемый рабочий процесс:

1. **Настройка**: Настроить переменные окружения в файле `.env`
2. **Запуск**: Запустить сервер `uv run main.py`
3. **Подключение**: Подключить MCP клиент к серверу
4. **Получение структуры**: `fetch_1c_metadata()` - получить метаданные 1С
5. **Загрузка данных**: `fetch_1c_data()` - загрузить нужные данные в JSON
6. **Просмотр файлов**: `list_cached_data()` - посмотреть список сохраненных файлов
7. **Анализ структуры**: `get_file_structure()` - изучить структуру файла с данными
8. **Работа с данными**: `filter_local_data()` с сортировкой или `count_local_data()` - анализировать локальные данные

### Преимущества JSON-архитектуры:

- **Экономия контекста LLM**: Функции возвращают только краткую статусную информацию
- **Быстрая локальная работа**: Фильтрация, сортировка и анализ без обращения к 1С
- **Анализ структуры**: Автоматическое определение типов полей и примеров значений
- **Гибкая сортировка**: Сортировка по любому полю в прямом или обратном порядке
- **Персистентность**: Данные сохраняются между сессиями
- **Прозрачность**: Все данные доступны в читаемом JSON формате

Сервер предоставляет полнофункциональный интерфейс для интеграции ИИ-ассистентов с системой 1С через стандартный протокол MCP с оптимизацией для работы с большими объемами данных.

## Примеры использования

### Создание пользователя в системе 1С
```python
# Создание нового пользователя "игорь тестович"
mcp_connect_1c_mcp_create_1c_entity(
    entity_set="Catalog_Пользователи",
    data={
        "Code": "игорь тестович",
        "Description": "игорь тестович", 
        "DeletionMark": False,
        "IsFolder": False,
        "Parent_Key": "00000000-0000-0000-0000-000000000000",
        "Predefined": False,
        "ФизЛицо_Key": "00000000-0000-0000-0000-000000000000"
    }
)
```

Результат: Пользователь успешно создан с Ref_Key="6dddd61e-9c9a-11f0-9cff-7085c2496eb6"
